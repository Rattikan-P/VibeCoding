<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Perfect Match Parking</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #0f1419;
      background: linear-gradient(135deg, #0f1419 0%, #1a1f2e 50%, #0f1419 100%);
      min-height: 100vh;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #e2e8f0;
      overflow: hidden;
      padding: 20px;
    }

    .game-frame {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 500px;
      background: rgba(20, 25, 35, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 16px;
      padding: 20px;
      box-shadow:
        0 0 0 1px rgba(100, 150, 255, 0.1),
        0 20px 60px rgba(0, 0, 0, 0.5),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(100, 150, 255, 0.15);
      position: relative;
      overflow: hidden;
    }

    .game-frame::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: 16px;
      padding: 1px;
      background: linear-gradient(135deg, rgba(100, 150, 255, 0.2), transparent 50%, rgba(100, 150, 255, 0.1));
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events: none;
    }

    .game-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      position: relative;
      z-index: 1;
    }

    /* BOSS Alert Overlay */
    .boss-alert-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      animation: fadeIn 0.3s ease;
    }

    .boss-alert-overlay.fade-out {
      animation: fadeOut 0.5s ease forwards;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    .boss-alert-box {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 165, 0, 0.1));
      border: 3px solid rgba(255, 215, 0, 0.6);
      border-radius: 16px;
      padding: 40px 60px;
      text-align: center;
      box-shadow:
        0 0 40px rgba(255, 215, 0, 0.4),
        0 0 80px rgba(255, 215, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      animation: alertPulse 1s ease-in-out infinite;
    }

    @keyframes alertPulse {
      0%, 100% {
        transform: scale(1);
        box-shadow:
          0 0 40px rgba(255, 215, 0, 0.4),
          0 0 80px rgba(255, 215, 0, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.1);
      }
      50% {
        transform: scale(1.02);
        box-shadow:
          0 0 60px rgba(255, 215, 0, 0.6),
          0 0 100px rgba(255, 215, 0, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.15);
      }
    }

    .boss-alert-title {
      font-size: 2rem;
      font-weight: 800;
      color: #FFD700;
      letter-spacing: 4px;
      text-shadow:
        0 0 20px rgba(255, 215, 0, 0.8),
        0 0 40px rgba(255, 215, 0, 0.4);
      margin: 0 0 10px 0;
    }

    .boss-alert-subtitle {
      font-size: 1rem;
      font-weight: 600;
      color: #FFA500;
      letter-spacing: 2px;
      text-shadow: 0 0 10px rgba(255, 165, 0, 0.6);
    }

    /* Boss Level Popup Alert */
    .boss-level-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.5);
      z-index: 10000;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      padding: 30px 50px;
      background: rgba(0, 0, 0, 0.92);
      backdrop-filter: blur(15px);
      border-radius: 20px;
      border: 3px solid rgba(251, 191, 36, 0.7);
      box-shadow:
        0 0 40px rgba(251, 191, 36, 0.8),
        0 0 80px rgba(251, 191, 36, 0.5),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      opacity: 0;
      pointer-events: none;
    }

    .boss-level-popup.show {
      animation: bossPopupShow 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
    }

    @keyframes bossPopupShow {
      0% {
        transform: translate(-50%, -50%) scale(0.3);
        opacity: 0;
      }
      50% {
        transform: translate(-50%, -50%) scale(1.1);
        opacity: 1;
      }
      70% {
        transform: translate(-50%, -50%) scale(0.95);
        opacity: 1;
      }
      100% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
    }

    .boss-level-popup.hidden {
      display: none;
    }

    .boss-popup-icon {
      font-size: 2.5rem;
      animation: bossIconPulse 0.8s ease-in-out infinite;
    }

    .boss-popup-title {
      font-size: 2rem;
      font-weight: 900;
      letter-spacing: 3px;
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: none;
      filter: drop-shadow(0 0 15px rgba(251, 191, 36, 0.7));
    }

    .boss-popup-subtitle {
      font-size: 0.9rem;
      font-weight: 700;
      letter-spacing: 2px;
      color: #fbbf24;
      text-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
    }

    @keyframes bossIconPulse {
      0%, 100% {
        transform: scale(1);
        filter: drop-shadow(0 0 20px rgba(251, 191, 36, 0.8));
      }
      50% {
        transform: scale(1.15);
        filter: drop-shadow(0 0 40px rgba(251, 191, 36, 1));
      }
    }

    /* Compact Stats Dashboard */
    .stats-dashboard {
      display: flex;
      justify-content: center;
      gap: 20px;
      padding: 6px 0;
      background: rgba(20, 30, 45, 0.4);
      border-radius: 8px;
      margin: 6px 0;
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .stat-item-label {
      font-size: 0.65rem;
      font-weight: 600;
      letter-spacing: 1px;
      color: #94a3b8;
    }

    .stat-item-value {
      font-size: 0.9rem;
      font-weight: 700;
      color: #e2e8f0;
      min-width: 20px;
      text-align: center;
    }

    /* Header - Single line */
    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      gap: 12px;
      flex-shrink: 0;
      min-height: 40px;
    }

    .title-section h1 {
      font-size: 1.15rem;
      font-weight: 900;
      letter-spacing: 2px;
      margin: 0;
      white-space: nowrap;
      background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 50%, #fbbf24 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      filter: drop-shadow(0 0 12px rgba(96, 165, 250, 0.6))
              drop-shadow(0 0 24px rgba(167, 139, 250, 0.4));
      animation: titleGlow 3s ease-in-out infinite;
      text-shadow: none;
    }

    @keyframes titleGlow {
      0%, 100% {
        filter: drop-shadow(0 0 12px rgba(96, 165, 250, 0.6))
                drop-shadow(0 0 24px rgba(167, 139, 250, 0.4));
      }
      50% {
        filter: drop-shadow(0 0 18px rgba(96, 165, 250, 0.9))
                drop-shadow(0 0 36px rgba(167, 139, 250, 0.7))
                drop-shadow(0 0 48px rgba(251, 191, 36, 0.3));
      }
    }

    .controls-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .icon-btn {
      background: rgba(30, 40, 55, 0.8);
      border: 1px solid rgba(100, 150, 255, 0.2);
      border-radius: 10px;
      color: #94a3b8;
      padding: 6px 12px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-size: 1rem;
      box-shadow:
        0 2px 8px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
    }

    .icon-btn:hover:not(:disabled) {
      background: rgba(40, 50, 70, 0.9);
      border-color: rgba(100, 150, 255, 0.4);
      color: #e2e8f0;
      transform: translateY(-2px);
      box-shadow:
        0 4px 12px rgba(100, 150, 255, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .icon-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    /* Level Header + Passenger + Stats - Compact */
    .game-info-section {
      display: flex;
      flex-direction: column;
      gap: 6px;
      width: 100%;
      flex-shrink: 0;
      padding-top: 4px;
    }

    /* Level Header - Above passenger queue */
    .level-header {
      text-align: center;
      font-size: 0.85rem;
      font-weight: 700;
      letter-spacing: 2px;
      padding: 5px 16px;
      background: rgba(30, 40, 55, 0.6);
      border-radius: 8px;
      border: 1px solid rgba(100, 150, 255, 0.15);
      box-shadow:
        0 2px 8px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
    }

    /* Unified Navigation Row */
    .navigation-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      width: 100%;
      padding: 6px 0;
    }

    .nav-btn {
      background: rgba(30, 40, 55, 0.7);
      border: 1px solid rgba(100, 150, 255, 0.25);
      border-radius: 8px;
      color: #94a3b8;
      padding: 6px 14px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow:
        0 2px 6px rgba(0, 0, 0, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      min-width: 70px;
      text-align: center;
    }

    .nav-btn:hover:not(:disabled) {
      background: rgba(40, 50, 70, 0.9);
      border-color: rgba(100, 150, 255, 0.4);
      color: #e2e8f0;
      transform: translateY(-1px);
      box-shadow:
        0 4px 10px rgba(100, 150, 255, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .nav-btn:disabled {
      background: rgba(60, 70, 90, 0.4) !important;
      border-color: rgba(100, 150, 255, 0.1) !important;
      color: #64748b !important;
      cursor: not-allowed !important;
      opacity: 0.5 !important;
      transform: none !important;
      pointer-events: none !important;
      box-shadow:
        0 2px 4px rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.02) !important;
    }

    .nav-btn:disabled:hover {
      background: rgba(60, 70, 90, 0.4) !important;
      border-color: rgba(100, 150, 255, 0.1) !important;
      transform: none !important;
    }

    .nav-level-display {
      background: rgba(30, 40, 55, 0.7);
      border: 1px solid rgba(100, 150, 255, 0.2);
      border-radius: 8px;
      padding: 6px 20px;
      font-size: 0.85rem;
      font-weight: 700;
      letter-spacing: 2px;
      color: #e2e8f0;
      box-shadow:
        0 2px 6px rgba(0, 0, 0, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      min-width: 80px;
      text-align: center;
    }

    /* Passenger Display - With color glow */
    .passenger-display {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      background: rgba(30, 58, 95, 0.6);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 14px 20px;
      border-radius: 12px;
      border: 1px solid rgba(100, 150, 255, 0.2);
      box-shadow:
        0 4px 16px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      transition: box-shadow 0.3s ease;
      min-height: 64px;
    }

    /* Passenger Section - Dual Slot Queue */
    .passenger-section {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
    }

    .passenger-slot {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      border-radius: 10px;
      transition: all 0.3s ease;
    }

    /* Primary Slot (Current Passenger) */
    .primary-slot {
      background: rgba(30, 58, 95, 0.6);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(100, 150, 255, 0.2);
      box-shadow:
        0 4px 16px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      flex: 1;
    }

    /* Color glow for primary slot */
    .primary-slot.passenger-color-red {
      box-shadow:
        0 0 20px rgba(234, 67, 53, 0.5),
        0 4px 16px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      border-color: rgba(234, 67, 53, 0.4);
    }

    .primary-slot.passenger-color-blue {
      box-shadow:
        0 0 20px rgba(66, 133, 244, 0.5),
        0 4px 16px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      border-color: rgba(66, 133, 244, 0.4);
    }

    .primary-slot.passenger-color-green {
      box-shadow:
        0 0 20px rgba(52, 168, 83, 0.5),
        0 4px 16px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      border-color: rgba(52, 168, 83, 0.4);
    }

    .primary-slot.passenger-color-yellow {
      box-shadow:
        0 0 20px rgba(251, 188, 5, 0.5),
        0 4px 16px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      border-color: rgba(251, 188, 5, 0.4);
    }

    .primary-slot.passenger-color-purple {
      box-shadow:
        0 0 20px rgba(103, 58, 183, 0.5),
        0 4px 16px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      border-color: rgba(103, 58, 183, 0.4);
    }

    /* Secondary Slot (Next Passenger Preview) */
    .secondary-slot {
      background: rgba(25, 35, 50, 0.4);
      border: 1px solid rgba(100, 150, 255, 0.15);
      box-shadow:
        0 2px 8px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      flex: 0.8;
      opacity: 0.7;
    }

    /* Preview Slot (Upcoming Passenger) - Very Compact */
    .preview-slot {
      background: rgba(20, 30, 45, 0.3);
      border: 2px dashed rgba(100, 150, 255, 0.2);
      box-shadow:
        0 2px 8px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      flex: 0.45;
      padding: 6px 10px;
      opacity: 0.6;
    }

    .preview-slot:hover {
      background: rgba(25, 35, 50, 0.4);
      border-color: rgba(100, 150, 255, 0.25);
    }

    /* Slot Labels */
    .passenger-slot-label {
      font-size: 0.65rem;
      font-weight: 700;
      letter-spacing: 1.5px;
      color: #94a3b8;
      text-align: center;
    }

    .secondary-slot .passenger-slot-label {
      font-size: 0.6rem;
      color: #64748b;
    }

    .preview-slot .passenger-slot-label {
      font-size: 0.6rem;
      color: #64748b;
    }

    /* Slot Content */
    .passenger-slot-content {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 44px;
    }

    /* Color glow for passenger display */
    .passenger-display.passenger-color-red {
      box-shadow:
        0 0 20px rgba(234, 67, 53, 0.5),
        0 4px 16px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      border-color: rgba(234, 67, 53, 0.4);
    }

    .passenger-display.passenger-color-blue {
      box-shadow:
        0 0 20px rgba(66, 133, 244, 0.5),
        0 4px 16px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      border-color: rgba(66, 133, 244, 0.4);
    }

    .passenger-display.passenger-color-green {
      box-shadow:
        0 0 20px rgba(52, 168, 83, 0.5),
        0 4px 16px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      border-color: rgba(52, 168, 83, 0.4);
    }

    .passenger-display.passenger-color-yellow {
      box-shadow:
        0 0 20px rgba(251, 188, 5, 0.5),
        0 4px 16px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      border-color: rgba(251, 188, 5, 0.4);
    }

    .passenger-display.passenger-color-purple {
      box-shadow:
        0 0 20px rgba(103, 58, 183, 0.5),
        0 4px 16px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      border-color: rgba(103, 58, 183, 0.4);
    }

    .passenger-display span {
      font-size: 0.8rem;
      font-weight: 600;
      letter-spacing: 0.5px;
      color: #e5e7eb;
    }

    /* Passenger Person Icon with Colored Shirt */
    .passenger-person-icon {
      width: 40px;
      height: 40px;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    /* Head - skin tone/white */
    .passenger-person-icon::before {
      content: '';
      position: absolute;
      top: 5px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #ffdbac;
      background: linear-gradient(145deg, #ffe4cc, #ffd499);
      box-shadow:
        0 2px 4px rgba(0, 0, 0, 0.3),
        inset 0 -2px 4px rgba(0, 0, 0, 0.1);
      z-index: 2;
    }

    /* Body/Shirt - colored dynamically */
    .passenger-person-icon::after {
      content: '';
      position: absolute;
      top: 20px;
      width: 32px;
      height: 18px;
      border-radius: 14px 14px 6px 6px;
      background: #4285f4;
      box-shadow:
        0 2px 6px rgba(0, 0, 0, 0.3),
        inset 0 2px 4px rgba(255, 255, 255, 0.3),
        inset 0 -2px 4px rgba(0, 0, 0, 0.2);
      z-index: 1;
    }

    /* Shirt Colors - exact hex codes */
    .passenger-person-icon.passenger-color-red::after {
      background: #ea4335;
    }

    .passenger-person-icon.passenger-color-blue::after {
      background: #4285f4;
    }

    .passenger-person-icon.passenger-color-green::after {
      background: #34a853;
    }

    .passenger-person-icon.passenger-color-yellow::after {
      background: #fbbc05;
    }

    .passenger-person-icon.passenger-color-purple::after {
      background: #673ab7;
    }

    /* Next Passenger Preview */
    .next-passenger-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      opacity: 0.5;
      filter: grayscale(30%);
    }

    .next-passenger-label {
      font-size: 0.55rem;
      font-weight: 600;
      letter-spacing: 0.5px;
      color: #64748b;
    }

    .next-passenger-icon {
      width: 28px;
      height: 28px;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transform: scale(0.75);
    }

    /* Next passenger head */
    .next-passenger-icon::before {
      content: '';
      position: absolute;
      top: 3px;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #ffdbac;
      background: linear-gradient(145deg, #ffe4cc, #ffd499);
      box-shadow:
        0 1px 3px rgba(0, 0, 0, 0.2),
        inset 0 -1px 2px rgba(0, 0, 0, 0.1);
      z-index: 2;
    }

    /* Next passenger body */
    .next-passenger-icon::after {
      content: '';
      position: absolute;
      top: 16px;
      width: 22px;
      height: 14px;
      border-radius: 12px 12px 5px 5px;
      background: #4285f4;
      box-shadow:
        0 1px 4px rgba(0, 0, 0, 0.2),
        inset 0 1px 2px rgba(255, 255, 255, 0.3),
        inset 0 -1px 2px rgba(0, 0, 0, 0.2);
      z-index: 1;
    }

    /* Next passenger shirt colors */
    .next-passenger-icon.passenger-color-red::after {
      background: #ea4335;
    }

    .next-passenger-icon.passenger-color-blue::after {
      background: #4285f4;
    }

    .next-passenger-icon.passenger-color-green::after {
      background: #34a853;
    }

    .next-passenger-icon.passenger-color-yellow::after {
      background: #fbbc05;
    }

    .next-passenger-icon.passenger-color-purple::after {
      background: #673ab7;
    }

    /* Grid - Fixed size, dynamic internal blocks */
    .grid-container {
      display: grid;
      grid-template-columns: repeat(var(--grid-size), 1fr);
      grid-template-rows: repeat(var(--grid-size), 1fr);
      width: 100%;
      max-width: 400px;
      aspect-ratio: 1 / 1;
      gap: 3px;
      background: rgba(15, 20, 30, 0.6);
      padding: 6px;
      border-radius: 10px;
      border: 1px solid rgba(100, 150, 255, 0.1);
      box-shadow:
        0 4px 16px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.05),
        inset 0 -2px 4px rgba(0, 0, 0, 0.3);
      flex-shrink: 0;
    }

    .cell {
      width: 100%;
      aspect-ratio: 1 / 1;
      border-radius: 5px;
      background: rgba(25, 35, 50, 0.6);
      border: 1px solid rgba(100, 150, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: default;
      transition: all 0.2s ease;
      box-shadow:
        inset 0 2px 4px rgba(0, 0, 0, 0.4),
        inset 0 -1px 0 rgba(255, 255, 255, 0.05);
    }

    .cell.has-car {
      cursor: pointer;
      border-color: rgba(100, 150, 255, 0.25);
    }

    .cell.has-car:not(.blocked):hover {
      transform: scale(1.05);
      border-color: rgba(100, 150, 255, 0.5);
      box-shadow:
        inset 0 2px 4px rgba(0, 0, 0, 0.4),
        0 0 12px rgba(100, 150, 255, 0.3);
    }

    .cell.has-car.blocked {
      opacity: 0.35;
      cursor: not-allowed;
    }

    /* Cars - 0.65s movement animation */
    .car {
      width: 100%;
      height: 100%;
      border-radius: 4px;
      transition: all 0.65s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
    }

    .car::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      height: 70%;
      border-radius: 3px;
      border: 2px solid rgba(0, 0, 0, 0.2);
      z-index: 2;
    }

    .car::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 45%;
      height: 40%;
      border-radius: 2px;
      background: rgba(0, 0, 0, 0.15);
      z-index: 3;
    }

    /* Car colors - exact hex codes */
    .car.color-red { background: #ea4335; }
    .car.color-red::before { background: #ea4335; }

    .car.color-blue { background: #4285f4; }
    .car.color-blue::before { background: #4285f4; }

    .car.color-green { background: #34a853; }
    .car.color-green::before { background: #34a853; }

    .car.color-yellow { background: #fbbc05; }
    .car.color-yellow::before { background: #fbbc05; }

    .car.color-purple { background: #673ab7; }
    .car.color-purple::before { background: #673ab7; }

    /* Waiting Zone - Compact */
    .waiting-zone-container {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
      padding-top: 4px;
    }

    .waiting-zone-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      padding: 4px 12px;
      background: rgba(30, 40, 55, 0.8);
      border-radius: 8px;
      border: 1px solid rgba(100, 150, 255, 0.2);
      box-shadow:
        0 2px 8px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
    }

    .waiting-zone-label {
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 1.5px;
      color: #94a3b8;
    }

    .waiting-zone-counter {
      font-size: 0.75rem;
      font-weight: 700;
      color: #e2e8f0;
      background: rgba(40, 50, 70, 0.8);
      padding: 3px 10px;
      border-radius: 6px;
      min-width: 40px;
      text-align: center;
      border: 1px solid rgba(100, 150, 255, 0.2);
    }

    .waiting-zone {
      display: flex;
      gap: 6px;
      justify-content: center;
      padding: 4px;
      width: 100%;
      background: rgba(20, 30, 45, 0.6);
      border-radius: 8px;
      border: 1px solid rgba(100, 150, 255, 0.15);
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
      align-items: center;
    }

    .slot {
      width: 46px;
      aspect-ratio: 1 / 1;
      border-radius: 8px;
      background: rgba(25, 35, 50, 0.5);
      border: 2px dashed rgba(100, 150, 255, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.4);
      flex-shrink: 0;
    }

    .slot.occupied {
      border-style: solid;
      background: rgba(35, 45, 65, 0.6);
      border-color: rgba(100, 150, 255, 0.3);
    }

    /* Slot Cars - for waiting zone (blocks, not humans) */
    .slot-car {
      width: 100%;
      height: 100%;
      border-radius: 6px;
      transition: all 0.65s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
    }

    .slot-car::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      height: 70%;
      border-radius: 4px;
      border: 2px solid rgba(0, 0, 0, 0.2);
      z-index: 2;
    }

    .slot-car::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 45%;
      height: 40%;
      border-radius: 3px;
      background: rgba(0, 0, 0, 0.15);
      z-index: 3;
    }

    /* Slot car colors - exact hex codes */
    .slot-car.color-red { background: #ea4335; }
    .slot-car.color-red::before { background: #ea4335; }

    .slot-car.color-blue { background: #4285f4; }
    .slot-car.color-blue::before { background: #4285f4; }

    .slot-car.color-green { background: #34a853; }
    .slot-car.color-green::before { background: #34a853; }

    .slot-car.color-yellow { background: #fbbc05; }
    .slot-car.color-yellow::before { background: #fbbc05; }

    .slot-car.color-purple { background: #673ab7; }
    .slot-car.color-purple::before { background: #673ab7; }

    /* Match Animations */
    @keyframes matchSuccess {
      0% { transform: scale(1); }
      50% { transform: scale(1.15); box-shadow: 0 0 20px rgba(255, 255, 255, 0.6); }
      100% { transform: scale(0); opacity: 0; }
    }

    @keyframes passengerDepart {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); box-shadow: 0 0 25px rgba(255, 255, 255, 0.7); }
      100% { transform: scale(0); opacity: 0; }
    }

    .passenger-display.departing {
      animation: passengerDepart 0.65s ease-out forwards;
    }

    .primary-slot.departing {
      animation: passengerDepart 0.65s ease-out forwards;
    }

    /* Passenger Walking Animation - Next walks into Current */
    @keyframes passengerWalkIn {
      0% {
        transform: translateX(40px) scale(0.5);
        opacity: 0.6;
      }
      25% {
        transform: translateX(30px) scale(0.6) translateY(-2px);
        opacity: 0.7;
      }
      50% {
        transform: translateX(20px) scale(0.7) translateY(0px);
        opacity: 0.8;
      }
      75% {
        transform: translateX(10px) scale(0.85) translateY(-2px);
        opacity: 0.9;
      }
      100% {
        transform: translateX(0) scale(1) translateY(0);
        opacity: 1;
      }
    }

    /* Walking animation with bobbing steps */
    .passenger-slide-in {
      animation: passengerWalkIn 0.5s ease-in-out forwards;
    }

    /* Gold Pulse Highlight */
    @keyframes goldPulse {
      0%, 100% {
        border-color: #FFD700;
        box-shadow: 0 0 10px rgba(255, 215, 0, 0.5), 0 0 20px rgba(255, 215, 0, 0.3);
      }
      50% {
        border-color: #FFA500;
        box-shadow: 0 0 15px rgba(255, 215, 0, 0.8), 0 0 30px rgba(255, 215, 0, 0.5);
      }
    }

    .slot-car.match-ready {
      animation: goldPulse 0.6s ease-in-out infinite;
      border: 3px solid #FFD700 !important;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.6), 0 0 30px rgba(255, 215, 0, 0.4) !important;
      transform: scale(1.05);
      border-radius: 8px;
    }

    .slot.matching .slot-car {
      animation: matchSuccess 0.65s ease-out forwards;
    }

    /* End Screen */
    .end-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 20, 25, 0.92);
      backdrop-filter: blur(20px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.4s ease-in-out;
    }

    .end-screen:not(.hidden) {
      opacity: 1;
    }

    .end-screen.hidden {
      display: none;
      opacity: 0;
    }

    .overlay-card {
      background: rgba(30, 40, 55, 0.7);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      color: #e2e8f0;
      padding: 50px;
      border-radius: 24px;
      text-align: center;
      max-width: 90%;
      width: 450px;
      animation: slideUpFade 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid rgba(100, 150, 255, 0.3);
      box-shadow:
        0 25px 70px rgba(0, 0, 0, 0.5),
        0 0 40px rgba(100, 150, 255, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    @keyframes slideUpFade {
      from {
        opacity: 0;
        transform: translateY(40px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .overlay-card h2 {
      font-size: 2rem;
      font-weight: 600;
      margin: 0 0 16px 0;
    }

    .overlay-card.level-complete h2 {
      color: #60a5fa;
    }

    .overlay-card.level-10 h2 {
      color: #FFD700;
      text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
    }

    .overlay-card.lose h2 {
      color: #f87171;
    }

    .overlay-card p {
      font-size: 1.1rem;
      margin: 0 0 24px 0;
      color: #94a3b8;
    }

    .end-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .action-btn {
      padding: 12px 24px;
      font-size: 0.95rem;
      font-weight: 600;
      background: rgba(40, 50, 70, 0.8);
      border: 1px solid rgba(100, 150, 255, 0.3);
      border-radius: 10px;
      color: #e2e8f0;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow:
        0 4px 12px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
    }

    .action-btn:hover {
      background: rgba(50, 60, 85, 0.9);
      border-color: rgba(100, 150, 255, 0.5);
      transform: translateY(-2px);
      box-shadow:
        0 6px 20px rgba(100, 150, 255, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .action-btn.primary {
      background: linear-gradient(135deg, #34a853, #2D9147);
      border-color: rgba(52, 168, 83, 0.5);
    }

    .action-btn.primary:hover {
      background: linear-gradient(135deg, #2D9147, #257a3a);
    }

    .action-btn:disabled {
      background: rgba(60, 70, 90, 0.5) !important;
      border-color: rgba(100, 150, 255, 0.1) !important;
      color: #64748b !important;
      cursor: not-allowed !important;
      opacity: 0.5 !important;
      transform: none !important;
      box-shadow:
        0 2px 6px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.02) !important;
    }

    .action-btn:disabled:hover {
      background: rgba(60, 70, 90, 0.5) !important;
      border-color: rgba(100, 150, 255, 0.1) !important;
      transform: none !important;
      box-shadow:
        0 2px 6px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.02) !important;
    }

    /* Welcome Screen */
    .welcome-container {
      text-align: center;
      color: #e2e8f0;
    }

    .welcome-title {
      font-size: 3rem;
      font-weight: 800;
      margin: 0 0 16px 0;
      letter-spacing: 2px;
    }

    .gradient-purple {
      background: linear-gradient(135deg, #a78bfa, #fb7185);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    background-clip: text;
    }

    .gradient-blue {
    background: linear-gradient(135deg, #38bdf8, #6366f1);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .gradient-orange {
      background: linear-gradient(135deg, #fbbf24, #2dd4bf);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .welcome-subtitle {
      font-size: 1.3rem;
      margin: 0 0 40px 0;
      color: #94a3b8;
    }

    .welcome-instructions {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin: 0 0 40px 0;
      text-align: left;
    }

    .instruction-item {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1rem;
      padding: 14px 18px;
      background: rgba(30, 40, 55, 0.6);
      border-radius: 10px;
      border: 1px solid rgba(100, 150, 255, 0.1);
      color: #cbd5e1;
      transition: all 0.3s ease;
    }

    .instruction-item:hover {
      background: rgba(35, 45, 65, 0.7);
      border-color: rgba(100, 150, 255, 0.2);
      transform: translateX(4px);
    }

    .instruction-icon {
      font-size: 1.5rem;
    }

    .welcome-start-btn {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: #ffffff;
      border: none;
      padding: 16px 56px;
      font-size: 1.1rem;
      font-weight: 700;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow:
        0 4px 20px rgba(59, 130, 246, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .welcome-start-btn:hover {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      transform: translateY(-2px);
      box-shadow:
        0 6px 30px rgba(59, 130, 246, 0.6),
        inset 0 1px 0 rgba(255, 255, 255, 0.15);
    }

    /* Game Over Screen Styles */
    .game-over-title {
      background: linear-gradient(135deg, #f87171, #dc2626);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .game-over-subtitle {
      font-size: 1.3rem;
      margin: 0 0 30px 0;
      color: #94a3b8;
    }

    .game-over-stats {
      display: flex;
      justify-content: center;
      margin: 0 0 40px 0;
    }

    .stat-highlight {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 20px 40px;
      background: rgba(30, 40, 55, 0.6);
      border-radius: 12px;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .stat-highlight .stat-label {
      font-size: 0.8rem;
      font-weight: 600;
      letter-spacing: 2px;
      color: #f87171;
    }

    .stat-highlight .stat-value {
      font-size: 2.5rem;
      font-weight: 800;
      color: #e2e8f0;
    }

    /* Victory Screen Styles */
    .victory-subtitle {
      font-size: 1.3rem;
      margin: 0 0 30px 0;
      color: #fbbf24;
    }

    .victory-stats {
      display: flex;
      justify-content: center;
      margin: 0 0 40px 0;
    }

    .victory-stat {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 32px;
      background: rgba(30, 40, 55, 0.6);
      border-radius: 12px;
      border: 1px solid rgba(251, 191, 36, 0.3);
    }

    .victory-icon {
      font-size: 2rem;
    }

    .victory-text {
      font-size: 1.1rem;
      font-weight: 600;
      color: #fbbf24;
      letter-spacing: 1px;
    }

    /* Level Complete Screen Styles */
    .level-complete-title {
      font-size: 2.8rem;
      line-height: 1.2;
      margin: 0 0 16px 0;
      font-weight: 800;
      animation: titleBounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    @keyframes titleBounce {
      0% {
        transform: scale(0.5);
        opacity: 0;
      }
      50% {
        transform: scale(1.1);
      }
      70% {
        transform: scale(0.95);
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .level-complete-stats {
      font-size: 1.1rem;
      margin: 0 0 35px 0;
      color: #94a3b8;
    }

    .level-complete-buttons {
      display: flex;
      flex-direction: column;
      gap: 15px;
      align-items: center;
      width: 100%;
    }

    /* Primary Button - Next Level */
    .level-complete-btn.primary {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: #ffffff;
      border: none;
      padding: 16px 56px;
      font-size: 1.1rem;
      font-weight: 800;
      letter-spacing: 1px;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow:
        0 4px 20px rgba(59, 130, 246, 0.5),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
      min-width: 220px;
      text-transform: uppercase;
    }

    .level-complete-btn.primary:hover {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      transform: translateY(-3px) scale(1.02);
      box-shadow:
        0 8px 35px rgba(59, 130, 246, 0.7),
        inset 0 1px 0 rgba(255, 255, 255, 0.25);
    }

    /* Secondary Buttons Row */
    .secondary-buttons-row {
      display: flex;
      gap: 12px;
      justify-content: center;
      width: 100%;
    }

    .level-complete-btn.secondary {
      background: rgba(40, 50, 70, 0.6);
      border: 2px solid rgba(100, 150, 255, 0.3);
      color: #cbd5e1;
      padding: 12px 28px;
      font-size: 0.9rem;
      font-weight: 600;
      letter-spacing: 0.5px;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow:
        0 2px 8px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      min-width: 120px;
      text-transform: uppercase;
    }

    .level-complete-btn.secondary:hover {
      background: rgba(50, 60, 85, 0.9);
      border-color: rgba(100, 150, 255, 0.5);
      transform: translateY(-2px);
      box-shadow:
        0 6px 20px rgba(100, 150, 255, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    /* Confetti */
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      background-color: #f00;
      animation: confetti-fall linear forwards;
      z-index: 9999;
    }

    @keyframes confetti-fall {
      0% {
        transform: translateY(-100vh) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
      }
    }

    /* Light Theme */
    body.light-theme {
      background: #f5f7fa;
      background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 50%, #f5f7fa 100%);
    }

    body.light-theme .game-frame {
      background: rgba(255, 255, 255, 0.95);
      border-color: rgba(0, 0, 0, 0.1);
    }

    body.light-theme .game-frame::before {
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.05), transparent 50%, rgba(0, 0, 0, 0.03));
    }

    body.light-theme .title-section h1 {
      background: linear-gradient(135deg, #2563eb, #7c3aed);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    body.light-theme .icon-btn {
      background: rgba(255, 255, 255, 0.9);
      border-color: rgba(0, 0, 0, 0.15);
      color: #475569;
      box-shadow:
        0 2px 8px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }

    body.light-theme .icon-btn:hover:not(:disabled) {
      background: rgba(248, 250, 252, 0.95);
      border-color: rgba(0, 0, 0, 0.25);
      color: #1e293b;
      box-shadow:
        0 4px 12px rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 1);
    }

    body.light-theme .level-header {
      background: rgba(255, 255, 255, 0.9);
      border-color: rgba(0, 0, 0, 0.15);
      color: #475569;
      box-shadow:
        0 2px 8px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }

    body.light-theme .nav-btn {
      background: rgba(255, 255, 255, 0.9);
      border-color: rgba(0, 0, 0, 0.2);
      color: #475569;
      box-shadow:
        0 2px 6px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }

    body.light-theme .nav-btn:hover:not(:disabled) {
      background: rgba(248, 250, 252, 0.95);
      border-color: rgba(0, 0, 0, 0.3);
      color: #1e293b;
    }

    body.light-theme .nav-btn:disabled {
      background: rgba(203, 213, 225, 0.4) !important;
      border-color: rgba(0, 0, 0, 0.1) !important;
      color: #94a3b8 !important;
      pointer-events: none !important;
      box-shadow:
        0 2px 4px rgba(0, 0, 0, 0.05),
        inset 0 1px 0 rgba(255, 255, 255, 0.5) !important;
    }

    body.light-theme .nav-btn:disabled:hover {
      background: rgba(203, 213, 225, 0.4) !important;
      border-color: rgba(0, 0, 0, 0.1) !important;
    }

    body.light-theme .nav-level-display {
      background: rgba(255, 255, 255, 0.9);
      border-color: rgba(0, 0, 0, 0.15);
      color: #1e293b;
      box-shadow:
        0 2px 6px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }

    body.light-theme .stats-dashboard {
      background: rgba(255, 255, 255, 0.7);
      border-color: rgba(0, 0, 0, 0.1);
    }

    body.light-theme .stat-item-label {
      color: #64748b;
    }

    body.light-theme .stat-item-value {
      color: #1e293b;
    }

    body.light-theme .passenger-display {
      background: rgba(219, 234, 254, 0.5);
      border-color: rgba(59, 130, 246, 0.3);
    }

    body.light-theme .passenger-display span {
      color: #475569;
    }

    body.light-theme .passenger-slot {
      background: rgba(255, 255, 255, 0.9);
      border-color: rgba(0, 0, 0, 0.15);
    }

    body.light-theme .primary-slot {
      background: rgba(219, 234, 254, 0.4);
      border-color: rgba(59, 130, 246, 0.3);
    }

    body.light-theme .preview-slot {
      background: rgba(248, 250, 252, 0.6);
      border: 2px dashed rgba(0, 0, 0, 0.15);
    }

    body.light-theme .preview-slot:hover {
      background: rgba(255, 255, 255, 0.8);
      border-color: rgba(0, 0, 0, 0.2);
    }

    body.light-theme .passenger-slot-label {
      color: #475569;
    }

    body.light-theme .preview-slot .passenger-slot-label {
      color: #64748b;
    }

    body.light-theme .grid-container {
      background: rgba(241, 245, 249, 0.8);
      border-color: rgba(0, 0, 0, 0.1);
      box-shadow:
        0 4px 16px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.8),
        inset 0 -2px 4px rgba(0, 0, 0, 0.05);
    }

    body.light-theme .cell {
      background: rgba(255, 255, 255, 0.9);
      border-color: rgba(0, 0, 0, 0.1);
      box-shadow:
        inset 0 2px 4px rgba(0, 0, 0, 0.05),
        inset 0 -1px 0 rgba(255, 255, 255, 0.8);
    }

    body.light-theme .cell.has-car:not(.blocked):hover {
      border-color: rgba(59, 130, 246, 0.4);
      box-shadow:
        inset 0 2px 4px rgba(0, 0, 0, 0.05),
        0 0 12px rgba(59, 130, 246, 0.2);
    }

    body.light-theme .waiting-zone-header {
      background: rgba(255, 255, 255, 0.9);
      border-color: rgba(0, 0, 0, 0.15);
      box-shadow:
        0 2px 8px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }

    body.light-theme .waiting-zone-label {
      color: #64748b;
    }

    body.light-theme .waiting-zone-counter {
      background: rgba(248, 250, 252, 0.9);
      color: #1e293b;
      border-color: rgba(0, 0, 0, 0.15);
    }

    body.light-theme .waiting-zone {
      background: rgba(241, 245, 249, 0.6);
      border-color: rgba(0, 0, 0, 0.1);
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    body.light-theme .slot {
      background: rgba(255, 255, 255, 0.8);
      border-color: rgba(0, 0, 0, 0.2);
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    body.light-theme .slot.occupied {
      background: rgba(248, 250, 252, 0.9);
      border-color: rgba(59, 130, 246, 0.3);
    }

    body.light-theme .overlay-card {
      background: rgba(255, 255, 255, 0.95);
      color: #1e293b;
      border-color: rgba(0, 0, 0, 0.15);
    }

    body.light-theme .overlay-card p {
      color: #64748b;
    }

    body.light-theme .action-btn {
      background: rgba(255, 255, 255, 0.9);
      border-color: rgba(0, 0, 0, 0.2);
      color: #1e293b;
      box-shadow:
        0 4px 12px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }

    body.light-theme .action-btn:hover {
      background: rgba(248, 250, 252, 0.95);
      border-color: rgba(0, 0, 0, 0.3);
    }

    body.light-theme .action-btn.primary {
      background: linear-gradient(135deg, #34a853, #2D9147);
      border-color: rgba(52, 168, 83, 0.5);
      color: #ffffff;
    }

    body.light-theme .action-btn:disabled {
      background: rgba(203, 213, 225, 0.5) !important;
      border-color: rgba(0, 0, 0, 0.1) !important;
      color: #94a3b8 !important;
      cursor: not-allowed !important;
      opacity: 0.5 !important;
      transform: none !important;
      box-shadow:
        0 2px 6px rgba(0, 0, 0, 0.05),
        inset 0 1px 0 rgba(255, 255, 255, 0.5) !important;
    }

    body.light-theme .action-btn:disabled:hover {
      background: rgba(203, 213, 225, 0.5) !important;
      border-color: rgba(0, 0, 0, 0.1) !important;
      transform: none !important;
      box-shadow:
        0 2px 6px rgba(0, 0, 0, 0.05),
        inset 0 1px 0 rgba(255, 255, 255, 0.5) !important;
    }

    /* Responsive */
    @media (max-width: 500px) {
      body {
        padding: 0;
      }

      .game-frame {
        max-width: 100%;
        border-radius: 0;
        padding: 12px;
      }

      h1 {
        font-size: 1rem;
      }

      .slot {
        width: 40px;
      }
    }
  </style>
</head>
<body>
  <div class="game-frame">
    <div class="game-container">
      <!-- Header - Single line -->
      <div class="header-row">
        <div class="title-section">
          <h1>PERFECT MATCH PARKING</h1>
        </div>
        <div class="controls-row">
          <button class="icon-btn" onclick="restartLevel()" title="Restart">‚Üª</button>
          <button class="icon-btn" onclick="toggleMode()" title="Toggle theme">‚óë</button>
        </div>
      </div>

      <!-- Navigation Row, Stats Dashboard, and Passenger Display -->
      <div class="game-info-section">
        <!-- Unified Navigation Row -->
        <div class="navigation-row">
          <button class="nav-btn" id="navPrevBtn" onclick="previousLevel()">‚Üê PREV</button>
          <div class="nav-level-display" id="navLevelDisplay">LVL 1</div>
          <button class="nav-btn" id="navNextBtn" onclick="nextLevel()">NEXT ‚Üí</button>
        </div>

        <!-- Compact Stats Dashboard -->
        <div class="stats-dashboard">
          <div class="stat-item">
            <span class="stat-item-label">MATCH</span>
            <span class="stat-item-value" id="match">0</span>
          </div>
          <div class="stat-item">
            <span class="stat-item-label">REMAINING</span>
            <span class="stat-item-value" id="remaining">0</span>
          </div>
          <div class="stat-item">
            <span class="stat-item-label">MOVE</span>
            <span class="stat-item-value" id="moves">0</span>
          </div>
        </div>

        <!-- Passenger Section - Dual Slot Queue -->
        <div class="passenger-section">
          <!-- Current Passenger Slot (Main) -->
          <div class="passenger-slot primary-slot" id="currentPassengerSlot">
            <div class="passenger-slot-label">NEXT</div>
            <div class="passenger-slot-content">
              <div class="passenger-person-icon" id="passengerIcon"></div>
            </div>
          </div>

          <!-- Preview Slot (Upcoming) -->
          <div class="passenger-slot preview-slot">
            <div class="passenger-slot-label">PREVIEW</div>
            <div class="passenger-slot-content">
              <div class="next-passenger-icon" id="nextPassengerIcon"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Grid - Fixed size, scales internal blocks -->
      <div class="grid-container" id="grid"></div>

      <!-- Waiting Zone - Compact, closer to grid -->
      <div class="waiting-zone-container">
        <div class="waiting-zone-header">
          <span class="waiting-zone-label">WAITING LANE</span>
          <span class="waiting-zone-counter" id="waitingCounter">0/5</span>
        </div>
        <div class="waiting-zone" id="waitingZone"></div>
      </div>
    </div>
  </div>

  <!-- Boss Level Popup Alert -->
  <div id="bossLevelPopup" class="boss-level-popup hidden">
    <div class="boss-popup-icon">‚ö†Ô∏è</div>
    <div class="boss-popup-title">BOSS LEVEL</div>
    <div class="boss-popup-subtitle">FINAL CHALLENGE</div>
  </div>

  <!-- BOSS Alert Overlay -->
  <div class="boss-alert-overlay" id="bossAlertOverlay" style="display: none;">
    <div class="boss-alert-box">
      <div class="boss-alert-title">WARNING</div>
      <div class="boss-alert-subtitle">FINAL BOSS LEVEL!</div>
    </div>
  </div>

  <!-- Welcome Screen -->
  <div class="end-screen" id="welcomeScreen">
    <div class="welcome-container">
      <h1 class="welcome-title">
        <span class="gradient-purple">Perfect</span>
        <span class="gradient-blue">Match</span>
        <span class="gradient-orange"> Parking</span>
      </h1>
      <p class="welcome-subtitle">Match colored cars to passengers</p>
      <div class="welcome-instructions">
        <div class="instruction-item">
          <span class="instruction-icon">üöó</span>
          <span>Click cars to move them to the waiting lane</span>
        </div>
        <div class="instruction-item">
          <span class="instruction-icon">üë§</span>
          <span>Match the passenger's color to clear cars</span>
        </div>
        <div class="instruction-item">
          <span class="instruction-icon">üéØ</span>
          <span>Clear the parking lot to win!</span>
        </div>
      </div>
      <button class="welcome-start-btn" onclick="startGame()">START GAME</button>
    </div>
  </div>

  <!-- Game Over Screen -->
  <div class="end-screen hidden" id="gameOverScreen">
    <div class="welcome-container">
      <h1 class="welcome-title game-over-title">GAME OVER</h1>
      <p class="game-over-subtitle" id="gameOverScore"></p>
      <div class="game-over-stats">
        <div class="stat-highlight">
          <span class="stat-label">MATCH</span>
          <span class="stat-value" id="gameOverMatch">0</span>
        </div>
      </div>
      <button class="welcome-start-btn" onclick="restartLevel()">RETRY</button>
    </div>
  </div>

  <!-- Victory Screen -->
  <div class="end-screen hidden" id="victoryScreen">
    <div class="welcome-container">
      <h1 class="welcome-title">
        <span class="gradient-purple">CONGRATULATIONS!</span>
      </h1>
      <p class="victory-subtitle">YOU MASTERED THE PARKING!</p>
      <div class="victory-stats">
        <div class="victory-stat">
          <span class="victory-icon">üèÜ</span>
          <span class="victory-text">All Levels Cleared</span>
        </div>
      </div>
      <button class="welcome-start-btn" onclick="playAgain()">PLAY AGAIN</button>
    </div>
  </div>

  <!-- Level Complete Screen -->
  <div class="end-screen hidden" id="levelCompleteScreen">
    <div class="overlay-card">
      <h1 class="welcome-title level-complete-title">
        <span class="gradient-orange">LEVEL</span>
        <span id="levelCompleteNumber" class="gradient-purple">1</span>
        <span class="gradient-orange">CLEARED!</span>
      </h1>
      <p class="level-complete-stats" id="levelCompleteStats"></p>
      <div class="level-complete-buttons" id="levelCompleteButtons">
        <!-- Buttons will be dynamically added -->
      </div>
    </div>
  </div>

  <script>
    // Game Configuration
    const ALL_COLORS = ['red', 'blue', 'green', 'yellow', 'purple'];
    const COLOR_CLASS_PREFIX = 'color-';
    const PASSENGER_CLASS_PREFIX = 'passenger-color-';

    // Game State
    let gameState = {
      level: 1,
      grid: [],
      initialGrid: null,
      gridSize: { rows: 6, cols: 6 },
      colors: [],
      waitingZoneSize: 5,
      waitingZone: [],
      passenger: '',
      nextPassenger: '',
      // Passenger queue: exact count of passengers matching cars on grid
      passengerQueue: [],
      status: 'playing',
      match: 0,
      moves: 0,
      isProcessingMatch: false,
      // Track which slots are currently matching (prevents DOM recreation)
      matchingSlots: [],
      // Track the highest level the player has ever cleared (0 = none, 1 = Level 1, etc.)
      maxLevelCleared: 0
    };

    // Load/Save Progress
    function loadProgress() {
      const savedMaxCleared = localStorage.getItem('zenPortMaxLevelCleared');
      if (savedMaxCleared) {
        const parsed = parseInt(savedMaxCleared);
        if (!isNaN(parsed) && parsed >= 0 && parsed <= 10) {
          gameState.maxLevelCleared = parsed;
        }
      }
    }

    function saveProgress() {
      localStorage.setItem('zenPortMaxLevelCleared', gameState.maxLevelCleared.toString());
    }

    // Level Configuration
    function getLevelConfig(level) {
      if (level >= 1 && level <= 3) {
        return {
          gridSize: { rows: 4, cols: 4 },
          colors: ALL_COLORS.slice(0, 3),
          fillPercent: 0.75,
          waitingZoneSize: 5
        };
      } else if (level >= 4 && level <= 6) {
        return {
          gridSize: { rows: 5, cols: 5 },
          colors: ALL_COLORS.slice(0, 4),
          fillPercent: 0.80,
          waitingZoneSize: 5
        };
      } else if (level >= 7 && level <= 9) {
        const fillPercent = Math.min(0.82 + ((level - 7) * 0.02), 0.90);
        return {
          gridSize: { rows: 6, cols: 6 },
          colors: ALL_COLORS.slice(0, 4),
          fillPercent: fillPercent,
          waitingZoneSize: 5
        };
      } else {
        return {
          gridSize: { rows: 7, cols: 7 },
          colors: ALL_COLORS.slice(0, 5),
          fillPercent: 0.90,
          waitingZoneSize: 5
        };
      }
    }

    // Toggle Theme
    function toggleMode() {
      const body = document.body;
      body.classList.toggle('light-theme');
      const isLight = body.classList.contains('light-theme');
      sessionStorage.setItem('zenPortTheme', isLight ? 'light' : 'dark');
    }

    // Load theme from session storage
    function loadTheme() {
      const savedTheme = sessionStorage.getItem('zenPortTheme');
      if (savedTheme === 'light') {
        document.body.classList.add('light-theme');
      }
    }

    // Count Remaining Cars on Grid
    function countRemainingCars() {
      let count = 0;
      for (let row = 0; row < gameState.gridSize.rows; row++) {
        for (let col = 0; col < gameState.gridSize.cols; col++) {
          if (gameState.grid[row][col] !== null) {
            count++;
          }
        }
      }
      return count;
    }

    // Create Passenger Queue - exact count of passengers matching cars on grid
    function createPassengerQueue() {
      const colorCounts = {};

      // Count cars by color in grid
      for (let row = 0; row < gameState.gridSize.rows; row++) {
        for (let col = 0; col < gameState.gridSize.cols; col++) {
          const color = gameState.grid[row][col];
          if (color) {
            colorCounts[color] = (colorCounts[color] || 0) + 1;
          }
        }
      }

      // Create queue with exact passenger counts
      const queue = [];
      for (const color in colorCounts) {
        for (let i = 0; i < colorCounts[color]; i++) {
          queue.push(color);
        }
      }

      // Shuffle queue for randomness
      for (let i = queue.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [queue[i], queue[j]] = [queue[j], queue[i]];
      }

      return queue;
    }

    // Initialize Game
    function initGame() {
      const config = getLevelConfig(gameState.level);

      // Update max level reached
      if (gameState.level > gameState.maxLevelReached) {
        gameState.maxLevelReached = gameState.level;
        saveProgress();
      }

      gameState.grid = [];
      gameState.gridSize = config.gridSize;
      gameState.colors = config.colors;
      gameState.waitingZoneSize = config.waitingZoneSize;
      gameState.waitingZone = Array(config.waitingZoneSize).fill(null);
      gameState.passenger = '';
      gameState.nextPassenger = '';
      gameState.passengerQueue = [];
      gameState.matchingSlots = [];
      gameState.status = 'playing';
      gameState.moves = 0;
      gameState.match = 0; // Reset match to 0

      // Create grid
      for (let row = 0; row < config.gridSize.rows; row++) {
        gameState.grid[row] = [];
        for (let col = 0; col < config.gridSize.cols; col++) {
          if (Math.random() < config.fillPercent) {
            gameState.grid[row][col] = config.colors[Math.floor(Math.random() * config.colors.length)];
          } else {
            gameState.grid[row][col] = null;
          }
        }
      }

      ensureSolvability();
      gameState.initialGrid = gameState.grid.map(row => [...row]);

      // Create passenger queue with exact car counts
      gameState.passengerQueue = createPassengerQueue();
      generatePassenger();

      // CRITICAL: Check if initial passenger matches any cars in waiting zone
      // This ensures matching works from the start
      setTimeout(() => {
        checkForMatch();
      }, 300); // Let everything render first

      // Show Boss Level popup alert when entering Level 10
      if (gameState.level === 10) {
        console.log('Level 10 detected! Triggering boss popup...');
        triggerBossPopup();
      }

      render();
    }

    // Ensure Solvability
    function ensureSolvability() {
      const config = getLevelConfig(gameState.level);
      const colorCounts = {};
      config.colors.forEach(color => colorCounts[color] = 0);

      for (let row = 0; row < gameState.gridSize.rows; row++) {
        for (let col = 0; col < gameState.gridSize.cols; col++) {
          const color = gameState.grid[row][col];
          if (color) {
            colorCounts[color]++;
          }
        }
      }

      config.colors.forEach(color => {
        if (colorCounts[color] === 0) {
          for (let row = 0; row < gameState.gridSize.rows; row++) {
            for (let col = 0; col < gameState.gridSize.cols; col++) {
              if (gameState.grid[row][col] === null) {
                gameState.grid[row][col] = color;
                return;
              }
            }
          }
        }
      });
    }

    // Get Available Colors
    function getAvailableColors() {
      const availableColors = new Set();

      for (let row = 0; row < gameState.gridSize.rows; row++) {
        for (let col = 0; col < gameState.gridSize.cols; col++) {
          if (gameState.grid[row][col]) {
            availableColors.add(gameState.grid[row][col]);
          }
        }
      }

      for (let i = 0; i < gameState.waitingZone.length; i++) {
        if (gameState.waitingZone[i]) {
          availableColors.add(gameState.waitingZone[i]);
        }
      }

      return Array.from(availableColors);
    }

    // Generate Passenger - pull from queue (exact car-passenger count)
    function generatePassenger() {
      // Pull current passenger from queue
      if (!gameState.passenger && gameState.passengerQueue.length > 0) {
        gameState.passenger = gameState.passengerQueue.shift();
      }

      // Peek at next passenger without removing from queue
      if (gameState.passengerQueue.length > 0) {
        gameState.nextPassenger = gameState.passengerQueue[0];
      } else {
        gameState.nextPassenger = '';
      }

      // Render the new passenger state
      render();
    }

    // Check if Car is Blocked (bottom-up)
    function isCarBlocked(row, col) {
      for (let r = row + 1; r < gameState.gridSize.rows; r++) {
        if (gameState.grid[r][col] !== null) {
          return true;
        }
      }
      return false;
    }

    // Move Car to Waiting Zone
    function moveCarToWaitingZone(row, col) {
      // GLOBAL INPUT LOCK: Prevent clicks during match animation
      if (gameState.isProcessingMatch) {
        return false;
      }

      if (isCarBlocked(row, col)) {
        return false;
      }

      const emptySlotIndex = gameState.waitingZone.findIndex(slot => slot === null);
      if (emptySlotIndex === -1) {
        return false;
      }

      const carColor = gameState.grid[row][col];
      gameState.grid[row][col] = null;
      gameState.waitingZone[emptySlotIndex] = carColor;
      gameState.moves++;

      render();
      checkGameEnd();

      // DELAY: Let car animation complete (0.65s) + settle time (100ms) before checking match
      // This ensures the car is fully visible in the slot before match detection
      setTimeout(() => {
        checkForMatch();
      }, 750); // 650ms animation + 100ms settle time

      return true;
    }

    // Check for Match (with perfectly synchronized exit)
    function checkForMatch() {
      if (gameState.isProcessingMatch) {
        return;
      }

      const matchIndex = gameState.waitingZone.findIndex(car => car === gameState.passenger);

      if (matchIndex !== -1) {
        gameState.isProcessingMatch = true;

        // CRITICAL FIX: Track this slot as matching to prevent DOM recreation
        gameState.matchingSlots.push(matchIndex);

        // Immediately clear the slot to prevent double-trigger/blinking
        // The DOM element will still exist and animate, but the data is cleared
        const matchedColor = gameState.waitingZone[matchIndex];
        gameState.waitingZone[matchIndex] = null;
        gameState.match++;

        const slotElement = document.querySelectorAll('.slot')[matchIndex];
        const carElement = slotElement?.querySelector('.slot-car');
        const currentPassengerSlot = document.getElementById('currentPassengerSlot');

        if (carElement && currentPassengerSlot) {
          // PHASE 1: Highlight car with gold pulse (passenger glow stays active)
          carElement.classList.add('match-ready');

          // PHASE 2: Wait 0.35s - both car and passenger (with glow) stay fully visible
          // SNAPPY DELAY: Faster gameplay feel
          setTimeout(() => {
            // PHASE 3: Start simultaneous fade-out - car and passenger depart together
            slotElement.classList.add('matching');
            currentPassengerSlot.classList.add('departing');

            // PHASE 4: Wait for fade-out animation (0.65s) to complete
            setTimeout(() => {
              // Remove this slot from matching tracking
              gameState.matchingSlots = gameState.matchingSlots.filter(idx => idx !== matchIndex);

              // Auto-forward: Compact the waiting zone by shifting all cars to the front
              compactWaitingZone();

              // Transition: Pull next passenger from queue
              gameState.passenger = '';
              generatePassenger();

              // Remove animation classes after fade-out completes
              slotElement.classList.remove('matching');
              currentPassengerSlot.classList.remove('departing');

              // Trigger walking animation for new current passenger
              triggerPassengerSlideIn();

              // Small delay before render to allow walking animation to start
              setTimeout(() => {
                render();
                checkGameEnd();
              }, 100);

              // CRITICAL: Check if new passenger matches any car in waiting lane
              // This ensures automatic clearing continues with new passenger
              setTimeout(() => {
                gameState.isProcessingMatch = false; // Unlock input AFTER passenger arrives
                checkForMatch();
              }, 300); // 100ms render delay + 200ms to let passenger fully arrive
            }, 650); // Fade-out animation duration (0.65s)
          }, 350); // SNAPPY: Visibility delay reduced to 0.35s for faster gameplay
        } else {
          gameState.isProcessingMatch = false;
          gameState.matchingSlots = gameState.matchingSlots.filter(idx => idx !== matchIndex);
        }
      }
    }

    // Compact Waiting Zone - Shift all cars to fill gaps
    function compactWaitingZone() {
      // Filter out null values and pad with null at the end
      const cars = gameState.waitingZone.filter(car => car !== null);
      gameState.waitingZone = [...cars, ...Array(gameState.waitingZoneSize - cars.length).fill(null)];
    }

    // Check Win/Lose
    function checkWinCondition() {
      // Grid must be empty
      for (let row = 0; row < gameState.gridSize.rows; row++) {
        for (let col = 0; col < gameState.gridSize.cols; col++) {
          if (gameState.grid[row][col] !== null) {
            return false;
          }
        }
      }

      // Waiting zone must be empty
      for (let i = 0; i < gameState.waitingZone.length; i++) {
        if (gameState.waitingZone[i] !== null) {
          return false;
        }
      }

      // Passenger queue must be empty (all passengers served)
      if (gameState.passengerQueue.length > 0 || gameState.passenger) {
        return false;
      }

      return true;
    }

    function checkLoseCondition() {
      const isFull = gameState.waitingZone.every(slot => slot !== null);

      if (isFull) {
        const hasMatch = gameState.waitingZone.some(car => car === gameState.passenger);
        return !hasMatch;
      }

      return false;
    }

    function checkGameEnd() {
      if (checkWinCondition()) {
        gameState.status = 'won';
        showLevelCompleteScreen();
      } else if (checkLoseCondition()) {
        gameState.status = 'lost';
        showGameOverScreen();
      }
    }

    // Show Screens
    function showLevelCompleteScreen() {
      // Update maxLevelCleared if this is a new highest level
      if (gameState.level > gameState.maxLevelCleared && gameState.level < 10) {
        gameState.maxLevelCleared = gameState.level;
        saveProgress();
      }

      if (gameState.level === 10) {
        // Show Victory Screen
        document.getElementById('victoryScreen').classList.remove('hidden');
        triggerConfetti();
      } else {
        // Show Level Complete Screen (levels 1-9)
        const levelCompleteScreen = document.getElementById('levelCompleteScreen');
        const levelCompleteNumber = document.getElementById('levelCompleteNumber');
        const levelCompleteStats = document.getElementById('levelCompleteStats');
        const levelCompleteButtons = document.getElementById('levelCompleteButtons');

        // Update level number
        levelCompleteNumber.textContent = gameState.level;

        // Update stats
        levelCompleteStats.textContent = `Match: ${gameState.match} | Moves: ${gameState.moves}`;

        // Build buttons HTML with new layout
        let buttonsHTML = '';

        // Primary: Next Level button (only if level < 10)
        if (gameState.level < 10) {
          buttonsHTML += `<button class="level-complete-btn primary" onclick="nextLevel()">Next Level ‚Üí</button>`;
        }

        // Secondary row: Previous and Retry
        buttonsHTML += `<div class="secondary-buttons-row">`;

        // Previous Level button (only if level > 1)
        if (gameState.level > 1) {
          buttonsHTML += `<button class="level-complete-btn secondary" onclick="previousLevel()">‚Üê Prev</button>`;
        }

        // Retry Level button
        buttonsHTML += `<button class="level-complete-btn secondary" onclick="restartLevel()">‚Üª Retry</button>`;

        buttonsHTML += `</div>`;

        // Set buttons HTML
        levelCompleteButtons.innerHTML = buttonsHTML;

        // Show screen
        levelCompleteScreen.classList.remove('hidden');
      }
    }

    function showGameOverScreen() {
      const gameOverScreen = document.getElementById('gameOverScreen');
      const gameOverScore = document.getElementById('gameOverScore');
      const gameOverMatch = document.getElementById('gameOverMatch');

      // Update game over screen content
      gameOverScore.textContent = `The parking lane is full!`;
      gameOverMatch.textContent = gameState.match.toString();

      // Show game over screen
      gameOverScreen.classList.remove('hidden');
    }

    function playAgain() {
      // Reset to Level 1
      gameState.level = 1;
      gameState.maxLevelCleared = 0;
      saveProgress();

      document.getElementById('victoryScreen').classList.add('hidden');
      initGame();
    }

    function triggerConfetti() {
      const colors = ['#ea4335', '#4285f4', '#34a853', '#fbbc05', '#673ab7'];

      for (let i = 0; i < 100; i++) {
        setTimeout(() => {
          const confetti = document.createElement('div');
          confetti.className = 'confetti';
          confetti.style.left = Math.random() * 100 + 'vw';
          confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
          confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];

          document.body.appendChild(confetti);

          setTimeout(() => {
            confetti.remove();
          }, 4000);
        }, i * 20);
      }
    }

    // Navigation
    function nextLevel() {
      // Only allow if current level is cleared (level <= maxLevelCleared)
      if (gameState.level < 10 && gameState.level <= gameState.maxLevelCleared) {
        document.getElementById('levelCompleteScreen').classList.add('hidden');
        gameState.level++;
        initGame();
      }
    }

    function previousLevel() {
      // Allow going back if Level > 1
      if (gameState.level > 1) {
        document.getElementById('levelCompleteScreen').classList.add('hidden');
        gameState.level--;
        initGame();
      }
    }

    function restartLevel() {
      // Hide all end screens (Game Over, Victory, Level Complete)
      document.getElementById('gameOverScreen').classList.add('hidden');
      document.getElementById('victoryScreen').classList.add('hidden');
      document.getElementById('levelCompleteScreen').classList.add('hidden');

      // Reset all game states
      gameState.grid = gameState.initialGrid.map(row => [...row]);
      gameState.waitingZone = Array(gameState.waitingZoneSize).fill(null);
      gameState.passenger = '';
      gameState.nextPassenger = '';
      gameState.passengerQueue = createPassengerQueue();
      gameState.matchingSlots = [];
      gameState.isProcessingMatch = false; // CRITICAL: Reset match processing flag
      gameState.status = 'playing';
      gameState.moves = 0;
      gameState.match = 0; // Reset match to 0

      generatePassenger();
      render();

      // CRITICAL: Check if passenger matches after restart
      setTimeout(() => {
        checkForMatch();
      }, 300);
    }

    // Render Functions
    function render() {
      renderGrid();
      renderWaitingZone();
      renderPassenger();
      renderStats();
      renderLevelDisplay();
    }

    function renderGrid() {
      const gridElement = document.getElementById('grid');
      gridElement.innerHTML = '';

      // Use grid-size CSS variable for dynamic grid layout
      gridElement.style.setProperty('--grid-size', gameState.gridSize.rows);

      for (let row = 0; row < gameState.gridSize.rows; row++) {
        for (let col = 0; col < gameState.gridSize.cols; col++) {
          const cell = document.createElement('div');
          cell.className = 'cell';

          const carColor = gameState.grid[row][col];

          if (carColor) {
            cell.classList.add('has-car');

            if (isCarBlocked(row, col)) {
              cell.classList.add('blocked');
            }

            const car = document.createElement('div');
            car.className = `car ${COLOR_CLASS_PREFIX}${carColor}`;
            cell.appendChild(car);

            cell.addEventListener('click', () => {
              if (gameState.status === 'playing') {
                moveCarToWaitingZone(row, col);
              }
            });
          }

          gridElement.appendChild(cell);
        }
      }
    }

    function renderWaitingZone() {
      const waitingZoneElement = document.getElementById('waitingZone');
      const counterElement = document.getElementById('waitingCounter');
      waitingZoneElement.innerHTML = '';

      const carCount = gameState.waitingZone.filter(car => car !== null).length;
      counterElement.textContent = `${carCount}/5`;

      for (let i = 0; i < gameState.waitingZoneSize; i++) {
        // CRITICAL FIX: Skip rendering if this slot is currently matching
        // This prevents DOM recreation during animation, which causes flickering
        if (gameState.matchingSlots.includes(i)) {
          // Create a placeholder slot that won't be rendered
          const placeholder = document.createElement('div');
          placeholder.className = 'slot-placeholder';
          placeholder.style.display = 'none';
          waitingZoneElement.appendChild(placeholder);
          continue;
        }

        const slot = document.createElement('div');
        slot.className = 'slot';

        const carColor = gameState.waitingZone[i];
        if (carColor) {
          slot.classList.add('occupied');

          // Create car/block icon instead of human icon
          const car = document.createElement('div');
          car.className = `slot-car ${COLOR_CLASS_PREFIX}${carColor}`;
          slot.appendChild(car);
        }

        waitingZoneElement.appendChild(slot);
      }
    }

    function renderPassenger() {
      const passengerIcon = document.getElementById('passengerIcon');
      const nextPassengerIcon = document.getElementById('nextPassengerIcon');
      const currentPassengerSlot = document.getElementById('currentPassengerSlot');

      // Clear previous color classes and animations from current passenger icon and slot
      passengerIcon.className = 'passenger-person-icon';
      currentPassengerSlot.className = 'passenger-slot primary-slot';

      // Apply color class to current passenger icon (for colored shirt) and slot (for glow)
      if (gameState.passenger) {
        const colorClass = `${PASSENGER_CLASS_PREFIX}${gameState.passenger}`;
        passengerIcon.classList.add(colorClass);
        currentPassengerSlot.classList.add(colorClass);
      }

      // Clear and apply color to next passenger icon
      nextPassengerIcon.className = 'next-passenger-icon';
      if (gameState.nextPassenger) {
        const colorClass = `${PASSENGER_CLASS_PREFIX}${gameState.nextPassenger}`;
        nextPassengerIcon.classList.add(colorClass);
      }
    }

    // Function to trigger slide animation when passenger transitions
    function triggerPassengerSlideIn() {
      const passengerIcon = document.getElementById('passengerIcon');
      const currentPassengerSlot = document.getElementById('currentPassengerSlot');

      // Remove and re-add animation class to trigger it
      passengerIcon.classList.remove('passenger-slide-in');
      currentPassengerSlot.classList.remove('passenger-slide-in');

      // Force reflow
      void passengerIcon.offsetWidth;

      // Add slide animation
      passengerIcon.classList.add('passenger-slide-in');
      currentPassengerSlot.classList.add('passenger-slide-in');
    }

    function renderStats() {
      document.getElementById('match').textContent = gameState.match;
      document.getElementById('remaining').textContent = countRemainingCars();
      document.getElementById('moves').textContent = gameState.moves;
    }

    function renderLevelDisplay() {
      const navLevelDisplay = document.getElementById('navLevelDisplay');
      navLevelDisplay.textContent = `LVL ${gameState.level}`;

      // Update navigation button states
      updateNavigationButtons();
    }

    // Update navigation button states based on maxLevelCleared logic
    function updateNavigationButtons() {
      const prevBtn = document.getElementById('navPrevBtn');
      const nextBtn = document.getElementById('navNextBtn');

      // PREV Button: Only enabled if Level > 1
      prevBtn.disabled = gameState.level <= 1;

      // NEXT Button Logic (Max Level Cleared):
      // - If on Level 10: Show MAX and disable permanently
      // - Otherwise: Check if current level <= maxLevelCleared
      if (gameState.level >= 10) {
        // Level 10: Show MAX and disable permanently
        nextBtn.textContent = 'MAX';
        nextBtn.disabled = true;
      } else {
        // Levels 1-9: Show NEXT
        nextBtn.textContent = 'NEXT ‚Üí';

        // Disabled if currentLevel > maxLevelCleared (haven't beaten current level yet)
        // Enabled if currentLevel <= maxLevelCleared (have beaten this level before)
        nextBtn.disabled = gameState.level > gameState.maxLevelCleared;
      }
    }

    // Show BOSS Alert Overlay
    function showBossAlert() {
      const overlay = document.getElementById('bossAlertOverlay');
      overlay.style.display = 'flex';

      setTimeout(() => {
        overlay.classList.add('fade-out');
        setTimeout(() => {
          overlay.style.display = 'none';
          overlay.classList.remove('fade-out');
        }, 500);
      }, 2000);
    }

    // Trigger Boss Level Popup Alert
    function triggerBossPopup() {
      const popup = document.getElementById('bossLevelPopup');

      if (!popup) {
        console.error('Boss popup element not found!');
        return;
      }

      console.log('Showing Boss Level popup!');

      // Reset and show the popup with animation
      popup.classList.remove('hidden');
      popup.classList.remove('show');

      // Force reflow to restart animation
      void popup.offsetWidth;

      // Add show class to trigger animation
      popup.classList.add('show');

      // Hide after 2.5 seconds
      setTimeout(() => {
        console.log('Hiding Boss Level popup');
        popup.classList.remove('show');
        popup.classList.add('hidden');
      }, 2500);
    }

    // Start
    loadProgress();
    loadTheme();

    function showWelcomeScreen() {
      document.getElementById('welcomeScreen').classList.remove('hidden');
    }

    function startGame() {
      document.getElementById('welcomeScreen').classList.add('hidden');
      initGame();
    }

    showWelcomeScreen();
  </script>
</body>
</html>
